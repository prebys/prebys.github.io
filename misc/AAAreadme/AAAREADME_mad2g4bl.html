<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>



<meta content="text/html; charset=ISO-8859-1" http-equiv="content-type"><title>mad2g4bl</title></head><body>
<h1>mad2g4bl Documentation</h1>
<span style="font-style: italic;">(last modified March 12, 2020 by <a href="http://home.fnal.gov/%7Eprebys/">Eric Prebys</a>)</span><br>
<br>
These are notes on the program <a href="mad2g4bl.py">mad2g4lb.py</a>,
which is used to convert a MAD8 or MADX optics file.&nbsp; At the time
of this writing, it should be considered a "beta" release.<br>
<br>
This is not meant to generate a standalone program, but rather a file
fragment defining the geometry that can be included in another
file.&nbsp; In particular, the elements must be defined elsewhere,
based on the MAD "<span style="font-weight: bold;">TYPE</span>".<br>
<h2>General Operation</h2>
<br>
The program reads an optics file generated by the MAD8 or MADX program.
From this file, it reads the following columns:<br>
<div style="margin-left: 40px;"><span style="font-weight: bold;">
KEYWORD,NAME,TYPE,S,L,ANGLE,K1L,TILT</span><br>
</div>
These columns may be in any order, and any additional columns are ignored. <br>
<br>
The <span style="font-weight: bold;">KEYWORD, NAME, S, </span>and<span style="font-weight: bold;"> L</span>
columns are required, and the program will terminate if they are not
present.&nbsp; The others will be set to zero (or blank) if not
present.&nbsp; If the <span style="font-weight: bold;">TYPE</span> column is not present, then the types must be specified with the "<span style="font-weight: bold;">--typefile</span>' option, described in the next section.<br><br>
<br>
This file can be generated with, eg.<br>
<ul>
  <li>MADX</li>
  <ul>
    <li>select, flag=twiss, clear;<br>
select,&nbsp; flag=twiss, column=keyword,name,type,s,l,angle,k1l,k2l,tilt,betx,bety,alfx,alfy,mux,muy;!for EjP<br>
twiss,beta0=newstart,sequence=M4line,file="optics.dat";<br>
    </li>
  </ul>
</ul>
<ul>
  <li>MAD8</li>
  <ul>
    <li>select,optics
#s/#e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
!&nbsp; See file "optics"<br>
optics,betx=18.933,alfx=2.323,&amp;<br>
bety=3.175,&amp;<br>
alfy=-.652,dy=-.335,dpy=-.050,&amp;<br>
dx=0,dpx=0,x=0,px=0.001 &amp;<br>
columns=keyword,name,type,s,l,k0,k1,k2,tilt,BETX,ALFX,BETY,ALFY,MUX,MUY<br>
    </li>
  </ul>
</ul>
The program currently understands keywords RBEND, HKICKER, VKICKER,
QUADRUPOLE, and RCOLLIMATOR, although any parameters of RCOLLIMATOR
will be overriden by the local definition. For each of these KEYWORDS
it will place an instance of &lt;TYPE&gt;, renamed to
&lt;NAME&gt;.&nbsp; For MAD8, the types can be stored by specifying
"TYPE=&lt;TYPE&gt;" when the element is defined.&nbsp; For MADX, they
must be defined in an external file and specified with the "--typefile"
option, described in the next section.&nbsp; If an external file is
given for a MAD8 file, it will override the definitions in the
program.&nbsp; Any element which does not have a TYPE will be ignored.<br>
<br>
In calculating the magnetic fields, the program assumes the particles
are protons wiht a kinetic energy of 8 GeV.&nbsp; For MADX, future
versions will read this from the optics file.&nbsp; These can be
overriden with the "--particle" and "--energy" options, described in
the next section.<br>
<br>
Specific behavior for each type:<br>
<ul>
  <li style="font-weight: bold;">RBEND</li>
  <ul>
    <li>an instance of &lt;TYPE&gt; is placed, under the assumption that it is a "genericbend"</li>
    <li>It is renamed to &lt;NAME&gt;<br>
    </li>
    <li>the Bfield is set according to L and the ANGLE (or K0L for MAD8) in the optics file</li>
    <ul>
      <li>This is done with a default paramenter ("param -unset")
By_&lt;NAME&gt;, so it may be overriden be specifying it before the
optics file is loaded.</li>
    </ul>
    <li>If the field is non-zero, the magnet is rotated and shifted based on the bend and sagitta, to maximize aperture.</li>
    <li>If the field is non-zero, a "cornerarc" is placed with the appropriate angular bend to keep the reference particle on track.</li>
    <li>Regardless
of the length in the definition of &lt;TYPE&gt;, the fieldLength is set
to the the value of "L" in MAD. The ironLength
will be to this value wiht a default parameter of
ironLength_&lt;TYPE&gt;, which can be overriden in the calling program.</li>
  </ul>
  <li style="font-weight: bold;">HKICKER or VKICKER</li>
  <ul>
    <li style="font-weight: bold;"><span style="font-weight: normal;">The same as <span style="font-weight: bold;">RBEND</span>, except no "cornerarc" is placed.</span><br>
    </li>
  </ul>
  <li style="font-weight: bold;">QUADRUPOLE</li>

  <ul>
    <li>an instance of &lt;TYPE&gt; is placed, under the assumption that it is a "genericquad".</li>
    <li>it is renamed to &lt;NAME&gt;<br>
    </li>
    <li>The gradient is set according to L and K01 in the optics file</li>
    <li>The length will be overriden by "L" from the optics file.<br>
    </li>
  </ul>
  <li style="font-weight: bold;">RCOLLIMATOR</li>
  <ul>
    <li>an instance of &lt;TYPE&gt; is is placed</li>
    <li>Only the z location is specified (ie, length not overriden) to allow for "groups" to be placed as collimators.</li>
  </ul>
</ul>
For all element types, the parameters Start_&lt;NAME&gt; and
End_&lt;NAME&gt; will be set to the upstream and downstream z
locations, for use later.<br>
<br>
The paramters Start_&lt;output filename&gt; and End_&lt;output
filename&gt; will be set to the upstream z location of the first
element, and the downstream z location of the last element,
respectively.<br>
<br>
Note, all variable names will be made "legal" by sustituting a an underscore ("_") for "-", ".", or "$".&nbsp; <br>
<br>
<h2>Command Syntax and Option</h2>
The command usage is<br>
&gt; <span style="font-weight: bold;">mad2g4bl.py [options] &lt;optics_file&gt;</span><br>
<br>
where the &lt;optics file&gt; is the file generated by MAD or MADX, as
described in the previous section.&nbsp; Unless specified in an option,
the output filename will be derived by stripping the extension of the
optics file name and replacing it with ".g4bl".<br>
<br>
Supported options are:<br>
<ul>
  <li><span style="font-weight: bold;">--outputfile=&lt;filename&gt;</span>:&nbsp; specifies the output file.&nbsp; If not specifies, the default described above is used.</li>
  <li><span style="font-weight: bold;">--firstelement=&lt;NAME&gt;</span>:&nbsp; start processing the file at the first element with name &lt;NAME&gt;</li>
  <li><span style="font-weight: bold;">--lastelement=&lt;NAME&gt;</span>: stop processing the file at the first element with name &lt;NAME&gt;</li>
  <li><span style="font-weight: bold;">--particle=&lt;particle&gt;</span>: specify the particle type.&nbsp;
Currently supported: "proton","antiproton","electron","positron","mu+", and "mu-".&nbsp; Defaults to
"proton"</li>
  <li><span style="font-weight: bold;">--energy=&lt;MeV&gt;</span>:&nbsp; Particle kinetic energy, in MeV.&nbsp; Defaults to 8000.<br>
  </li>

  <li><span style="font-weight: bold;">--typefile</span>:&nbsp; a comma separated file containing the types for
each named element.&nbsp; Each line has the form
&lt;NAME&gt;,&lt;TYPE&gt;.&nbsp; If there are multiple assignments, the
last one will be used.&nbsp; This file is REQUIRED for MADX input.</li>
  <li><span style="font-weight: bold;">--nomerge</span>:&nbsp; It's common for beam line designers to split
elements, particularly quadrupoles in the middle, to facilitate
matching.&nbsp; By default, if the program sees to elements with the
same &lt;NAME&gt; and no space in between them, it will merge them
together.&nbsp; This option defeats this behavior and keeps them
separate.</li>
  <li><span style="font-weight: bold;">--split</span>:&nbsp; (please read!)&nbsp; The philosophy of this
program is that you should not have to edit the resulting output
files.&nbsp; That means you might want to go back and place elements
after the beam line is defined.&nbsp; The problems is that it's very
difficult in g4beamline to place something before a "cornerarc"
instance after the fact.&nbsp; If this option is set, then the output
file is split into separate files, with the breaks just after each
bending magnet (By!=0) and just before the corresponding
"cornerarc".&nbsp; This will allow the user to place elements in the
preceding section of beamline before inlcuding the next file.</li>
  <li><span style="font-weight: bold;">--centre: </span>By default, MAD(X) lists the S position at the <span style="font-style: italic;">end</span>
of each element.&nbsp; If the "centre" option is used in the TWISS
command, then it will list the S positions at the center of the
element.&nbsp; In that case, <span style="font-style: italic;">this option must be set for this program to interpret things correcly.</span>&nbsp; <br>
  </li>

</ul>
<h2>Known Issues and Features</h2>
<ul>
  <li>Strong bend magnets require a small step size, such as 1 mm, to
get the reference orbit right.&nbsp; This can be specifed with maxStep
whent the <span style="font-weight: bold;">TYPE</span> is defined.<br>
  </li>
  <li>For bend magnets, the program currently does not support any
rotations except 0 and 90 degrees.&nbsp; Intermediate values of <span style="font-weight: bold;">TILT</span> are rounded up or down to the nearest value</li>
  <li>At the moment, there may be quadrupoles with the same <span style="font-weight: bold;">NAME</span>, but bend magnets must each have a unique <span style="font-weight: bold;">NAME</span>.</li>
  <li>The program has not been tested with negative particles.</li>
  <li>The position correction of RBENDs isn't quite right for very large angles.</li>
  <li>This program has not yet been tested with Python 3, and probably doesn't work.<br>
  </li>



</ul><br>

<br>
<br>
<br>

  

</body></html>